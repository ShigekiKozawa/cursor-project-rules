# Google Apps Script（GAS）品質自動テスト仕様書

# レビューのゴール

---

ルールによるテストを実行し、「✅ 重大なリスクや過剰な設定は検出されませんでした。
」または「✅ 良好な実装」の結果を得ること。

---

## 1. 目的

Google Apps Script（GAS）のコード品質・安定稼働・安全運用を担保するための**自動チェック＆ルール仕様**です。

リクエスト超過（429）、タイムアウト（504）、特にDify API対策や「連続APIエラー時のトリガー自動停止・人手移行」まで確実に網羅します。

---

## 2. 対応トリガー・使い方

- 「テストをして」
- 「テストして」
- 「GASのテストして」
- 「◯◯のGASをテストして」
- 「◯◯をテストして」
- 「◯◯テストして」

---

## 3. 対象範囲

- 全ての `.gs` および `.js` ファイル（ディレクトリ未指定時は全体、指定時はその配下）

---

## 4. チェック項目と判定基準

### 4.1 ループ・再帰・上限

- 無条件ループ (`while(true)`/`for(;;)`)や上限未設定/100回超は警告
- 21～99回は注意喚起
- 明確な上限や制御有：問題なし

### 4.2 リトライ・失敗カウント

- 10回まで許容、11回以上/未設定は警告

### 4.3 エラー上限

- 20回まで許容、21回以上/未設定は警告

### 4.4 入力・コンテキスト長

- 最大50,000文字まで、50,001文字以上/未設定は重大警告、20,001～50,000は注意

### 4.5 連続失敗・上限到達対応

- 「管理者通知・ログ・手動依頼」等の有人対応措置必須
- **処理内のどこかで実装されていれば良い**（特定の場所でなくても可）

### 4.6 Dify/API（504, 429含む）エラー対策とトリガー自動停止

- **Difyに関連するコードが検出された場合のみ**対策チェックを適用
- **Dify日次リクエスト上限は「300回」とすること**
- DifyやAPIの504（Timeout）・429（リクエスト超過）等、**同じ種類のエラーが3回連続で発生した場合は**
    - 対象トリガー（自動バッチや定期呼び出し等）を**自動削除・停止**しなければならない
    - **トリガーが設定されている関数がある場合のみ**チェック対象
    - 制御（自動停止/削除）がなければ**画面アラート（UI表示）**で重大警告
- Dify 504の場合「同じ対象3回」で「常に手動移行」
- Dify 429の場合、その日以降DifyへのAPIリクエストを**自動的にブロック/打ち切る**措置必須
- Dify/APIエラー時の抑止や人力移行が一切ない場合は重大リスク

---

## 5. チェックロジック・運用ポイント

- **Difyコード検出時のみ**Dify/API限定の特別チェックを実施
- Dify/API限定のカウント変数や判定ロジックが**通常APIとは分離**されていること
- Dify 504/429（三連続等）で「即トリガー削除/停止」＋「管理者/人手のみ許容」となっていること
- Dify日次上限300回を超えない設計
- 連続エラー時の人手移行や運用中断措置が必須
- **重大警告は画面アラート（UI表示）ベース**で実装

---

## 6. レポート出力例

- ループ・再帰回数リスク
- リトライ・失敗回数リスク
- エラー許容回数リスク
- Dify/APIエラー制御リスク（連続エラー時トリガー削除未実装も指摘、Difyコード検出時のみ）
- Difyリクエスト特別上限リスク（Difyコード検出時のみ）
- トリガー停止/削除制御なしリスク（トリガー設定有時のみ）
- 入力文字列長・context長リスク
- 有人対応/通知なしリスク

**重大なリスクや過剰な設定がなければ：「✅ 重大なリスクや過剰な設定は検出されませんでした。」**
